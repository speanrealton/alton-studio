// src/app/marketplace/page.tsx  ← RESPONSIVE PROFESSIONAL LAYOUT WITH REAL-TIME FEATURES
'use client';

import { useEffect, useState, useRef } from 'react';
import { supabase } from '@/lib/supabase';
import Link from 'next/link';
import Image from 'next/image';
import { Flame, Heart, MessageCircle, Share2, User, Upload, Home, Search, PlusCircle, Bell, Play, Volume2, VolumeX, Eye, Check, Copy, DollarSign } from 'lucide-react';
import CurrencyConverter from '@/components/CurrencyConverter';
import type { CurrencyCode } from '@/lib/currencies';
  const [currentUser, setCurrentUser] = useState<any>(null);
  const [commentText, setCommentText] = useState<{ [key: string]: string }>({});
  const [commentsByDrop, setCommentsByDrop] = useState<any>({});
  const [loading, setLoading] = useState(true);
  const [userCurrency, setUserCurrency] = useState<CurrencyCode>('USD');
  const [currentIndex, setCurrentIndex] = useState(0);
  const [dropErrors, setDropErrors] = useState<{ [key: string]: boolean }>({});
  const [dropPaused, setDropPaused] = useState<{ [key: string]: boolean }>({});
  const [dropMuted, setDropMuted] = useState<{ [key: string]: boolean }>({});
  const [showComments, setShowComments] = useState<string | null>(null);
  const [following, setFollowing] = useState<string[]>([]);
  const [viewedDrops, setViewedDrops] = useState<Set<string>>(new Set());
  const [userLikes, setUserLikes] = useState<{ [key: string]: boolean }>({});
  const [sharedDrop, setSharedDrop] = useState<string | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const dropRefs = useRef<{ [key: string]: HTMLVideoElement }>({});

  useEffect(() => {
    supabase.auth.getUser().then(({ data }) => {
      setCurrentUser(data.user);
      if (data.user) {
        loadFollowing(data.user.id);
        loadUserLikes(data.user.id);
        
        // Load user's preferred currency
        const preferredCurrency = (data.user.user_metadata as any)?.preferred_currency || 'USD';
        setUserCurrency(preferredCurrency as CurrencyCode);
      }
    });

    loadAll();

    const channel = supabase
      .channel('drops-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'printing_videos' }, (payload: any) => {
        console.log('Drops updated in real-time:', payload);
        loadAll();
      })
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, (payload: any) => {
        console.log('New comment in real-time:', payload);
        const newComment = payload.new;
        setCommentsByDrop(prev => ({
          ...prev,
          [newComment.video_id]: [...(prev[newComment.video_id] || []), newComment]
        }));
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'user_follows' }, () => {
        console.log('Follows updated in real-time');
        if (currentUser) loadFollowing(currentUser.id);
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'video_likes' }, (payload: any) => {
        console.log('Likes updated in real-time:', payload);
        // Reload all videos to get updated like counts
        loadAll();
        // Also reload user likes
        if (currentUser) loadUserLikes(currentUser.id);
      })
      .subscribe();

    return () => { supabase.removeChannel(channel); };
  }, []);

  useEffect(() => {
    const currentDrop = drops[currentIndex];
    
    Object.keys(dropRefs.current).forEach((dropId) => {
      const drop = dropRefs.current[dropId];
      if (!drop) return;

      const isCurrentDrop = currentDrop?.id === dropId;
      const shouldPlay = isCurrentDrop && !dropPaused[dropId];

      if (shouldPlay) {
        if (drop.paused) {
          drop.currentTime = 0;
          
          // Increment view when drop starts playing (only once per drop)
          if (!viewedDrops.has(dropId)) {
            incrementView(dropId);
            setViewedDrops(prev => new Set([...prev, dropId]));
          }
          
          const playPromise = drop.play();
          if (playPromise !== undefined) {
            playPromise.catch(err => {
              if (err.name !== 'AbortError') {
                console.log('Play error:', err);
              }
            });
          }
        }
      } else {
        if (!drop.paused) {
          drop.pause();
        }
      }
    });
  }, [currentIndex, dropPaused, drops, viewedDrops]);

  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      // Don't intercept keys when typing in an input field
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
        return;
      }

      const currentDrop = drops[currentIndex];
      if (!currentDrop) return;

      switch(e.key) {
        case ' ':
          e.preventDefault();
          togglePlayPause(currentDrop.id);
          break;
        case 'ArrowUp':
          e.preventDefault();
          scrollToDrop(Math.max(0, currentIndex - 1));
          break;
        case 'ArrowDown':
          e.preventDefault();
          scrollToDrop(Math.min(drops.length - 1, currentIndex + 1));
          break;
        case 'm':
        case 'M':
          toggleMute(currentDrop.id);
          break;
        case 'l':
        case 'L':
          toggleLike(currentDrop.id);
          break;
      }
    };

    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [currentIndex, drops]);

  const loadFollowing = async (userId: string) => {
    const { data } = await supabase
      .from('user_follows')
      .select('following_id')
      .eq('follower_id', userId);
    
    setFollowing(data?.map(f => f.following_id) || []);
  };

  const loadUserLikes = async (userId: string) => {
    try {
      const { data: likesData } = await supabase
        .from('video_likes')
        .select('video_id')
        .eq('user_id', userId);
      
      const likes: { [key: string]: boolean } = {};
      likesData?.forEach(like => {
        likes[like.video_id] = true;
      });
      setUserLikes(likes);
    } catch (err) {
      console.error('Error loading user likes:', err);
    }
  };

  const loadAll = async () => {
    // Fetch drops
    const { data: dropsData } = await supabase
      .from('printing_videos')
      .select('id, video_url, creator_name, creator_username, creator_profile_picture, creator_id, tagged_product_slug, description, likes, liked_by, views, shop_link')
      .order('created_at', { ascending: false });

    // Fetch like counts from video_likes table
    const { data: likesData } = await supabase
      .from('video_likes')
      .select('video_id, user_id');

    // Create a map of drop likes count
    const likesCountMap: { [key: string]: number } = {};
    likesData?.forEach(like => {
      likesCountMap[like.video_id] = (likesCountMap[like.video_id] || 0) + 1;
    });

    // Update drops with actual like counts
    const dropsWithLikes = (dropsData || []).map(drop => ({
      ...drop,
      likes: likesCountMap[drop.id] || 0
    }));

    console.log('Loaded drops with likes:', dropsWithLikes);
    setDrops(dropsWithLikes);

    const { data: commentsData } = await supabase
      .from('comments')
      .select('*')
      .order('created_at', { ascending: false});

    const commentsByDrop: any = {};
    commentsData?.forEach(c => {
      if (!commentsByDrop[c.video_id]) commentsByDrop[c.video_id] = [];
      commentsByDrop[c.video_id].push(c);
    });

    setCommentsByDrop(commentsByDrop);
    
    // Ensure minimum 3 seconds loading time
    setTimeout(() => {
      setLoading(false);
    }, 3000);
  };

  const scrollToDrop = (index: number) => {
    if (containerRef.current) {
      containerRef.current.scrollTo({
        top: index * window.innerHeight,
        behavior: 'smooth'
      });
    }
  };

  const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
    const container = e.target as HTMLDivElement;
    const scrollPosition = container.scrollTop;
    const dropHeight = container.clientHeight;
    const newIndex = Math.round(scrollPosition / dropHeight);
    
    if (newIndex !== currentIndex && newIndex >= 0 && newIndex < drops.length) {
      setCurrentIndex(newIndex);
    }
  };

  const togglePlayPause = (dropId: string) => {
    const drop = dropRefs.current[dropId];
    if (!drop) return;

    if (drop.paused) {
      const playPromise = drop.play();
      if (playPromise !== undefined) {
        playPromise.catch(err => {
          if (err.name !== 'AbortError') {
            console.log('Play error:', err);
          }
        });
      }
      setDropPaused(prev => ({ ...prev, [dropId]: false }));
    } else {
      drop.pause();
      setDropPaused(prev => ({ ...prev, [dropId]: true }));
    }
  };

  const toggleMute = (dropId: string) => {
    const drop = dropRefs.current[dropId];
    if (!drop) return;
    
    drop.muted = !drop.muted;
    setDropMuted(prev => ({ ...prev, [dropId]: !prev[dropId] }));
  };

  const incrementView = async (dropId: string) => {
    try {
      // Get current views
      const currentDrop = drops.find(d => d.id === dropId);
      const newViews = (currentDrop?.views || 0) + 1;

      // Update in database
      await supabase
        .from('printing_videos')
        .update({ views: newViews })
        .eq('id', dropId);

      // Update local state
      setDrops(prev => prev.map(d => 
        d.id === dropId ? { ...d, views: newViews } : d
      ));
    } catch (err) {
      console.error('Error incrementing view:', err);
    }
  };

  const formatViews = (views: number): string => {
    if (views >= 1000000) {
      return (views / 1000000).toFixed(1) + 'M';
    } else if (views >= 1000) {
      return (views / 1000).toFixed(1) + 'K';
    }
    return views.toString();
  };

  const toggleLike = async (dropId: string) => {
    if (!currentUser) {
      alert('Log in to like drops');
      return;
    }

    const hasLiked = userLikes[dropId] || false;

    // Update optimistic UI
    setUserLikes(prev => ({ ...prev, [dropId]: !hasLiked }));

    try {
      if (hasLiked) {
        // Delete like
        const { error } = await supabase
          .from('video_likes')
          .delete()
          .eq('video_id', dropId)
          .eq('user_id', currentUser.id);

        if (error) {
          console.error('Error removing like:', error);
          setUserLikes(prev => ({ ...prev, [dropId]: true }));
        }
      } else {
        // Add like with user info for notifications
        const userName = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'user';
        const userImage = currentUser.user_metadata?.profile_picture || null;
        
        const { error } = await supabase
          .from('video_likes')
          .insert({
            video_id: dropId,
            user_id: currentUser.id,
            user_name: userName,
            user_image: userImage
          });

        if (error) {
          console.error('Error adding like:', error);
          setUserLikes(prev => ({ ...prev, [dropId]: false }));
        }
      }
      
      // Reload drops to get updated like counts
      loadAll();
    } catch (err) {
      console.error('Error toggling like:', err);
      setUserLikes(prev => ({ ...prev, [dropId]: hasLiked }));
    }
  };

  const toggleFollow = async (creatorId: string) => {
    if (!currentUser) {
      alert('Log in to follow creators');
      return;
    }

    const isFollowing = following.includes(creatorId);

    if (isFollowing) {
      setFollowing(prev => prev.filter(id => id !== creatorId));
    } else {
      setFollowing(prev => [...prev, creatorId]);
    }

    if (isFollowing) {
      const { error } = await supabase
        .from('user_follows')
        .delete()
        .eq('follower_id', currentUser.id)
        .eq('following_id', creatorId);
      
      if (error) {
        console.error('Error unfollowing:', error);
        setFollowing(prev => [...prev, creatorId]);
      }
    } else {
      const { error } = await supabase
        .from('user_follows')
        .insert({
          follower_id: currentUser.id,
          following_id: creatorId
        });
      
      if (error) {
        console.error('Error following:', error);
        setFollowing(prev => prev.filter(id => id !== creatorId));
      }
    }
  };

  const shareDrop = async (url: string, creatorName: string, dropId: string) => {
    const fullUrl = `${window.location.origin}/marketplace?drop=${dropId}`;
    
    // Update share count in database
    const currentDrop = drops.find(d => d.id === dropId);
    const newShareCount = (currentDrop?.shares || 0) + 1;
    
    try {
      await supabase
        .from('printing_videos')
        .update({ shares: newShareCount })
        .eq('id', dropId);

      setDrops(prev => prev.map(d => 
        d.id === dropId ? { ...d, shares: newShareCount } : d
      ));
    } catch (err) {
      console.error('Error updating shares:', err);
    }

    // Show share feedback
    setSharedDrop(dropId);
    setTimeout(() => setSharedDrop(null), 2000);

    if (navigator.share) {
      try {
        await navigator.share({ 
          title: `Check out this drop by @${creatorName}!`, 
          url: fullUrl 
        });
      } catch (err) {
        console.log('Share cancelled');
      }
    } else {
      navigator.clipboard.writeText(fullUrl);
      alert('Link copied!');
    }
  };

  const sendComment = async (dropId: string) => {
    const text = commentText[dropId]?.trim();
    if (!text || !currentUser) {
      if (!currentUser) alert('Log in to comment');
      return;
    }

    // Get proper username - try multiple fields
    const userName = currentUser.user_metadata?.username 
      || currentUser.user_metadata?.name 
      || currentUser.email?.split('@')[0] 
      || currentUser.email 
      || 'user';
    
    const userImage = currentUser.user_metadata?.profile_picture 
      || currentUser.user_metadata?.avatar_url 
      || null;

    const newComment = {
      id: Date.now().toString(),
      video_id: dropId,
      user_name: userName,
      user_image: userImage,
      text,
      created_at: new Date().toISOString()
    };

    console.log('Sending comment with:', { userName, userImage, text }); // Debug

    // Optimistic update - show comment immediately
    setCommentsByDrop(prev => ({
      ...prev,
      [dropId]: [...(prev[dropId] || []), newComment]
    }));

    setCommentText(prev => ({ ...prev, [dropId]: '' }));

    // Save to database
    const { error } = await supabase.from('comments').insert({
      video_id: dropId,
      user_name: userName,
      user_image: userImage,
      text: text
    });

    if (error) {
      console.error('Error posting comment:', JSON.stringify(error, null, 2));
      console.error('Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      // Remove optimistic comment on error
      setCommentsByDrop(prev => ({
        ...prev,
        [dropId]: prev[dropId]?.filter(c => c.id !== newComment.id) || []
      }));
    } else {
      console.log('Comment posted successfully:', { userName, userImage, text });
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <div className="text-center">
          <img 
            src="/logo2.svg" 
            alt="Loading" 
            className="w-32 h-32 mx-auto animate-pulse drop-shadow-lg"
            style={{
              filter: 'drop-shadow(0 0 30px rgba(168, 85, 247, 0.8))',
              animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite, glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite'
            }}
          />
          <style>{`
            @keyframes glow {
              0%, 100% { filter: drop-shadow(0 0 20px rgba(168, 85, 247, 0.6)); }
              50% { filter: drop-shadow(0 0 40px rgba(168, 85, 247, 1)); }
            }
          `}</style>
        </div>
      </div>
    );
  }

  if (drops.length === 0) {
    return (
      <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center gap-6">
        <h1 className="text-3xl font-black">No drops yet</h1>
        <p className="text-base text-gray-400">Be the first to post!</p>
        <Link href="/marketplace/upload">
          <button className="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-4 rounded-full text-lg font-black hover:scale-105 transition">
            POST FIRST DROP
          </button>
        </Link>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black">
      {/* MOBILE TOP NAV - Only visible on mobile/tablet */}
      <nav className="lg:hidden fixed top-0 left-0 right-0 z-40 bg-black/95 backdrop-blur-lg border-b border-white/10">
        <div className="px-4 h-14 flex items-center justify-between">
          <Image 
            src="/dropslogo.svg" 
            alt="Logo" 
            width={35} 
            height={15}
            className="h-4 w-auto"
          />
          <div className="flex items-center gap-3">
            <Link href="/marketplace/upload">
              <Upload className="w-5 h-5 text-white" />
            </Link>
            <Link href="/marketplace/profile">
              <User className="w-5 h-5 text-white" />
            </Link>
          </div>
        </div>
        
        {/* Mobile horizontal menu */}
        <div className="flex items-center gap-1 px-2 py-2 overflow-x-auto">
          <Link href="/marketplace" className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-white/10 whitespace-nowrap text-xs font-semibold">
            <Home className="w-3.5 h-3.5" /> For You
          </Link>
          <Link href="/marketplace/following" className="flex items-center gap-1.5 px-3 py-1.5 rounded-full hover:bg-white/10 whitespace-nowrap text-xs text-gray-300">
            <Heart className="w-3.5 h-3.5" /> Following
          </Link>
          <Link href="/marketplace/explore" className="flex items-center gap-1.5 px-3 py-1.5 rounded-full hover:bg-white/10 whitespace-nowrap text-xs text-gray-300">
            <Search className="w-3.5 h-3.5" /> Explore
          </Link>
          <Link href="/marketplace/notifications" className="flex items-center gap-1.5 px-3 py-1.5 rounded-full hover:bg-white/10 whitespace-nowrap text-xs text-gray-300">
            <Bell className="w-3.5 h-3.5" /> Alerts
          </Link>
        </div>
      </nav>

      {/* DESKTOP SIDEBAR - Only visible on desktop */}
      <aside className="hidden lg:block fixed left-0 top-0 bottom-0 w-64 bg-black border-r border-white/10 z-40 overflow-y-auto">
        <div className="p-6">
          <Image 
            src="/logo.svg" 
            alt="Logo" 
            width={100} 
            height={40}
            className="h-10 w-auto mb-8"
          />

          {/* User Profile */}
          {currentUser && (
            <Link href="/marketplace/profile">
              <div className="flex items-center gap-3 mb-8 p-3 hover:bg-white/5 rounded-xl transition cursor-pointer">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center overflow-hidden border-2 border-white/20 flex-shrink-0">
                  {currentUser.user_metadata?.profile_picture ? (
                    <img 
                      src={currentUser.user_metadata.profile_picture} 
                      alt="Profile" 
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <User className="w-5 h-5 text-white" />
                  )}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-white font-bold text-xs truncate">
                    {currentUser.user_metadata?.username || currentUser.email?.split('@')[0]}
                  </p>
                  <p className="text-gray-400 text-[10px] truncate">{currentUser.email}</p>
                </div>
              </div>
            </Link>
          )}

          {/* Navigation */}
          <nav className="space-y-2">
            <Link href="/marketplace" className="flex items-center gap-3 text-white p-2 bg-white/10 rounded-xl font-semibold text-sm">
              <Home className="w-4 h-4" /> 
              <span>For You</span>
            </Link>
            <Link href="/marketplace/following" className="flex items-center gap-3 text-gray-400 p-2 hover:bg-white/5 rounded-xl transition text-sm">
              <Heart className="w-4 h-4" /> 
              <span>Following</span>
            </Link>
            <Link href="/marketplace/explore" className="flex items-center gap-3 text-gray-400 p-2 hover:bg-white/5 rounded-xl transition text-sm">
              <Search className="w-4 h-4" /> 
              <span>Explore</span>
            </Link>
            <Link href="/marketplace/profile" className="flex items-center gap-3 text-gray-400 p-2 hover:bg-white/5 rounded-xl transition text-sm">
              <User className="w-4 h-4" /> 
              <span>Profile</span>
            </Link>
            <Link href="/marketplace/notifications" className="flex items-center gap-3 text-gray-400 p-2 hover:bg-white/5 rounded-xl transition text-sm">
              <Bell className="w-4 h-4" /> 
              <span>Notifications</span>
            </Link>
          </nav>

          {/* Upload Button */}
          <Link href="/marketplace/upload">
            <button className="w-full mt-6 bg-gradient-to-r from-purple-600 to-pink-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:scale-105 transition">
              <Upload className="w-5 h-5" /> Upload
            </button>
          </Link>

          {/* Keyboard Shortcuts */}
          <div className="mt-8 pt-6 border-t border-white/10">
            <p className="text-[10px] text-gray-500 mb-2 font-semibold uppercase tracking-wider">Shortcuts</p>
            <div className="text-[10px] text-gray-400 space-y-1">
              <p><kbd className="bg-white/10 px-1.5 py-0.5 rounded text-[8px]">Space</kbd> Play/Pause</p>
              <p><kbd className="bg-white/10 px-1.5 py-0.5 rounded text-[8px]">↑↓</kbd> Navigate</p>
              <p><kbd className="bg-white/10 px-1.5 py-0.5 rounded text-[8px]">M</kbd> Mute</p>
              <p><kbd className="bg-white/10 px-1.5 py-0.5 rounded text-[8px]">L</kbd> Like</p>
            </div>
          </div>
        </div>
      </aside>

      {/* MAIN CONTENT - Adjusted for sidebar on desktop */}
      <main className="lg:ml-64 pt-[104px] lg:pt-0">
        <div className="flex items-center justify-center min-h-screen">
          <div 
            ref={containerRef}
            onScroll={handleScroll}
            className="h-screen w-full max-w-md overflow-y-scroll snap-y snap-mandatory bg-black"
            style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
          >
            <style jsx>{`
              div::-webkit-scrollbar {
                display: none;
              }
            `}</style>

            {drops.map((drop, index) => {
              const userLiked = userLikes[drop.id] || false;
              const isFollowing = currentUser && drop.creator_id && following.includes(drop.creator_id);
              const dropComments = commentsByDrop[drop.id] || [];
              const isShared = sharedDrop === drop.id;

              return (
                <div 
                  key={drop.id} 
                  className="relative h-screen w-full snap-start snap-always flex items-center justify-center bg-black"
                >
                  <div className="relative w-full h-[85vh] lg:h-[90vh] aspect-[9/16] mx-auto">
                    <video
                      ref={el => { if (el) dropRefs.current[drop.id] = el; }}
                      src={drop.video_url}
                      className="absolute inset-0 w-full h-full object-cover rounded-2xl lg:rounded-xl"
                      loop
                      playsInline
                      onClick={() => togglePlayPause(drop.id)}
                      onError={() => setDropErrors(prev => ({ ...prev, [drop.id]: true }))}
                      onLoadedData={() => setDropErrors(prev => ({ ...prev, [drop.id]: false }))}
                    />

                    {dropErrors[drop.id] && (
                      <div className="absolute inset-0 bg-red-900/80 rounded-2xl flex flex-col items-center justify-center text-white p-6">
                        <p className="text-2xl font-black mb-4">⚠️ Drop Error</p>
                        <p className="text-sm text-center mb-4">Failed to load</p>
                        <button 
                          onClick={() => window.location.reload()}
                          className="mt-6 bg-white text-black px-6 py-3 rounded-full font-bold"
                        >
                          Reload Page
                        </button>
                      </div>
                    )}

                    {dropPaused[drop.id] && (
                      <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div className="bg-black/50 rounded-full p-6">
                          <Play className="w-16 h-16 text-white" />
                        </div>
                      </div>
                    )}

                    <button
                      onClick={() => toggleMute(drop.id)}
                      className="absolute top-4 right-4 bg-black/50 backdrop-blur-sm rounded-full p-3 z-10"
                    >
                      {dropMuted[drop.id] ? 
                        <VolumeX className="w-6 h-6 text-white" /> : 
                        <Volume2 className="w-6 h-6 text-white" />
                      }
                    </button>

                    <div className="absolute right-3 bottom-40 flex flex-col gap-3 z-20">
                      <div className="flex flex-col items-center">
                        <Link href={`/marketplace/user/${drop.creator_id}`}>
                          <div className="relative cursor-pointer group">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center border-2 border-white shadow-lg overflow-hidden group-hover:scale-110 transition">
                              {drop.creator_profile_picture ? (
                                <img 
                                  src={drop.creator_profile_picture} 
                                  alt={drop.creator_username || drop.creator_name}
                                  className="w-full h-full object-cover"
                                  onError={(e) => {
                                    console.log('Image load error for:', drop.creator_profile_picture);
                                    e.currentTarget.style.display = 'none';
                                  }}
                                />
                              ) : (
                                <User className="w-5 h-5 text-white" />
                              )}
                            </div>
                            
                            {currentUser && drop.creator_id && drop.creator_id !== currentUser.id && !isFollowing && (
                              <button
                                onClick={(e) => {
                                  e.preventDefault();
                                  toggleFollow(drop.creator_id);
                                }}
                                className="absolute -bottom-2 left-1/2 -translate-x-1/2 transition-all hover:scale-125 active:scale-95 z-20"
                                title="Follow"
                              >
                                <div className="rounded-full p-1 shadow-xl border-2 border-white bg-red-500 hover:bg-red-600">
                                  <svg className="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                                    <path d="M12 5v14M5 12h14" />
                                  </svg>
                                </div>
                              </button>
                            )}
                          </div>
                        </Link>
                      </div>

                      <button 
                        onClick={() => toggleLike(drop.id)}
                        className="flex flex-col items-center transition-transform active:scale-90"
                      >
                        <div className={`backdrop-blur-sm rounded-full p-2 ${
                          userLiked ? 'bg-orange-500/20' : 'bg-black/40'
                        }`}>
                          <Flame 
                            className={`w-5 h-5 transition-all ${
                              userLiked ? 'text-orange-500 animate-pulse' : 'text-white'
                            }`} 
                          />
                        </div>
                        <span className={`text-[9px] font-bold mt-0.5 drop-shadow-lg ${
                          userLiked ? 'text-orange-500' : 'text-white'
                        }`}>
                          {drop.likes || 0}
                        </span>
                      </button>

                      <button
                        className="flex flex-col items-center"
                        disabled
                        title="Comments shown on the right"
                      >
                        <div className="bg-black/40 backdrop-blur-sm rounded-full p-2">
                          <MessageCircle className="w-5 h-5 text-white" />
                        </div>
                        <span className="text-white text-[9px] font-bold mt-0.5 drop-shadow-lg">
                          {dropComments.length}
                        </span>
                      </button>

                      <button 
                        onMouseDown={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          shareDrop(drop.video_url, drop.creator_name, drop.id);
                        }}
                        onClick={(e) => e.stopPropagation()}
                        className="flex flex-col items-center transition-transform active:scale-90 z-30 relative cursor-pointer"
                        type="button"
                        style={{pointerEvents: 'auto'}}
                      >
                        <div className={`rounded-full p-2 backdrop-blur-sm transition-all ${
                          isShared ? 'bg-green-500/20' : 'bg-black/40'
                        }`}>
                          {isShared ? (
                            <Check className="w-5 h-5 text-green-500" />
                          ) : (
                            <Share2 className="w-5 h-5 text-white" />
                          )}
                        </div>
                        {drop.shares > 0 && (
                          <span className="text-white text-[9px] font-bold mt-0.5 drop-shadow-lg">
                            {drop.shares}
                          </span>
                        )}
                      </button>
                    </div>

                    <div className="absolute bottom-0 left-0 right-0 p-4 z-10 bg-gradient-to-t from-black via-black/80 to-transparent pt-20">
                      <div className="mb-2">
                        <div className="flex items-center gap-3 mb-2">
                          <p className="text-white text-sm font-black drop-shadow-lg">
                            @{drop.creator_username}
                          </p>
                          {drop.views > 0 && (
                            <div className="flex items-center gap-1 bg-black/50 backdrop-blur-sm px-2 py-1 rounded-full">
                              <Eye className="w-3 h-3 text-gray-300" />
                              <span className="text-[10px] font-bold text-gray-300">
                                {formatViews(drop.views || 0)}
                              </span>
                            </div>
                          )}
                        </div>
                        
                        {drop.description && (
                          <p className="text-white text-xs mb-2 drop-shadow-lg line-clamp-2">
                            {drop.description}
                          </p>
                        )}

                        {drop.shop_link && (
                          <a href={drop.shop_link} target="_blank" rel="noopener noreferrer">
                            <button className="bg-white text-black text-[10px] font-bold px-3 py-1 rounded-full hover:scale-105 transition">
                              Visit here
                            </button>
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </main>

      {/* PERSISTENT COMMENTS PANEL - Floating right side */}
      <aside className="hidden lg:block fixed top-6 right-3 w-72 h-[calc(100vh-60px)] bg-black/80 backdrop-blur-sm border border-white/10 rounded-2xl z-40 overflow-hidden flex flex-col shadow-2xl">
        {drops.length > 0 && (
          <>
            {/* Comments Panel Header */}
            <div className="p-3 border-b border-white/10">
              <h3 className="text-sm font-black text-white">
                {commentsByDrop[drops[currentIndex]?.id]?.length || 0} Comments
              </h3>
            </div>

            {/* Comments List */}
            <div className="flex-1 overflow-y-auto p-3 space-y-2">
              {commentsByDrop[drops[currentIndex]?.id]?.map((c: any) => (
                <div key={c.id} className="flex gap-1.5">
                  <div className="w-6 h-6 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0 overflow-hidden">
                    {c.user_image ? (
                      <img 
                        src={c.user_image} 
                        alt={c.user_name}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          e.currentTarget.style.display = 'none';
                        }}
                      />
                    ) : (
                      <User className="w-2.5 h-2.5 text-white" />
                    )}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-white font-bold text-[11px] truncate">{c.user_name}</p>
                    <p className="text-white/80 text-[10px] break-words line-clamp-2">{c.text}</p>
                  </div>
                </div>
              ))}

              {(!commentsByDrop[drops[currentIndex]?.id] || commentsByDrop[drops[currentIndex]?.id].length === 0) && (
                <p className="text-center text-gray-400 py-6 text-[10px]">No comments yet. Be the first!</p>
              )}
            </div>

            {/* Comment Input */}
            <div className="p-2.5 border-t border-white/10 flex-shrink-0">
              <div className="flex gap-1.5">
                <input
                  placeholder="Comment..."
                  value={commentText[drops[currentIndex]?.id] || ''}
                  onChange={e => setCommentText({ ...commentText, [drops[currentIndex]?.id]: e.target.value })}
                  onKeyDown={e => e.key === 'Enter' && sendComment(drops[currentIndex]?.id)}
                  className="flex-1 bg-white/10 border border-white/20 rounded-full px-2.5 py-1.5 text-white text-xs placeholder:text-white/60"
                />
                <button 
                  onClick={() => sendComment(drops[currentIndex]?.id)}
                  className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-full px-3 py-1.5 font-bold text-[10px] hover:scale-105 transition"
                >
                  Post
                </button>
              </div>
            </div>
          </>
        )}
      </aside>
    </div>
  );
}